<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard</title>
    <link rel="stylesheet" href="./output.css">
</head>
<body class="bg-backgroundColor font-[Inter]">
    <!-- Dashboard Container -->
    <div class="min-h-screen flex flex-col">
        <!-- Header -->
        <header class="w-full h-20 items-center flex justify-between font-[Inter] border-b border-black px-4">
                <a href="./index.html" class="text-[13px] lg:text-[15px] font-bold">EduEthics</a>
                <h1 class="text-[13px] font-semibold lg:text-[14px]">Dashboard</h1>
        </header>

        <!-- Main Content -->
        <main class="flex-1">
            <div class="w-[90%] mx-auto py-6 sm:px-6 lg:px-8">
                <div class="px-4 py-6 sm:px-0">
                    <!-- Search Report by Tracking ID -->
                    <div class="mb-8">
                        <h3 class="text-[12px]">Search Report by Tracking ID</h3>
                        <div class="mt-4 flex text-[12px] lg:text-[14px]">
                            <input type="text" id="tracking-id" placeholder="Enter Tracking ID" class="px-2 text-gray-600 text-[11px] lg:text-[13px] w-full placeholder:text-[10px] placeholder:lg:text-[12px] flex-1 p-2 border border-black rounded-l-md focus:outline-none focus:ring-2 focus:ring-bgBlue">
                            <button onclick="fetchReport()" class="bg-bgBlue text-white px-4 py-2 rounded-r-md hover:bg-lightBlue">Search</button>
                        </div>
                    </div>

                    <!-- Report Details Section -->
                    <div id="report-details" class="bg-white overflow-hidden sm:rounded-lg hidden">
                        <div class="px-4 py-5 sm:px-6 border-b border-black">
                            <h3 class="text-[12px] lg:text-[14px] leading-6 font-bold">Report Details</h3>
                        </div>
                        <div class="">
                            <dl>
                                <div class="bg-white px-4 py-5 sm:grid sm:grid-cols-3 sm:gap-4 sm:px-6 border-b border-black">
                                    <dt class="text-[12px] lg:text-[14px] text-black font-medium italic">Tracking ID</dt>
                                    <dd id="tracking-id-detail" class="mt-1 text-[11px] lg:text-[13px] sm:col-span-2"></dd>
                                </div>
                                <div class="bg-white px-4 py-5 sm:grid sm:grid-cols-3 sm:gap-4 sm:px-6 border-b border-black">
                                    <dt class="text-[12px] lg:text-[14px] text-black font-medium italic">Description</dt>
                                    <dd id="description" class="mt-1 text-[11px] lg:text-[13px] sm:col-span-2"></dd>
                                </div>
                                <div class="bg-white px-4 py-5 sm:grid sm:grid-cols-3 sm:gap-4 sm:px-6 border-b border-black">
                                    <dt class="text-[12px] lg:text-[14px] text-black font-medium italic">Agency</dt>
                                    <dd id="agency" class="mt-1 text-[11px] lg:text-[13px] sm:col-span-2"></dd>
                                </div>
                                <div class="bg-white px-4 py-5 sm:grid sm:grid-cols-3 sm:gap-4 sm:px-6 border-b border-black">
                                    <dt class="text-[12px] lg:text-[14px] italic text-black font-medium">Reporter Email</dt>
                                    <dd id="reporter-email" class="mt-1 text-[11px] lg:text-[13px] sm:col-span-2"></dd>
                                </div>
                                
                            </dl>
                        </div>
                    </div>

                    <!-- Follow-up Message Section -->
                    <div id="follow-up-section" class="mt-8 bg-white sm:rounded-lg hidden">
                        <div class="px-4 py-5 sm:p-6">
                            <h3 class="text-[12px] lg:text-[14px] leading-6 font-medium">Send Follow-up Message</h3>
                            <form id="follow-up-form" class="mt-4">
                                <div class="grid grid-cols-1 gap-6">
                                    <div>
                                        <label for="message" class="block text-[12px] lg:text-[14px]">Message</label>
                                        <textarea id="message" name="message" rows="4" class="mt-1 block w-full py-2 px-3 border border-black bg-white rounded-md focus:outline-none focus:ring-2 focus:ring-bgBlue focus:border-lightBlue text-[12px] lg:text-[14px] placeholder:text-[10px] placeholder:lg:text-[12px] placeholder:px-3" placeholder="Write your follow-up message here..." required></textarea>
                                    </div>
                                </div>
                                <div class="mt-6">
                                    <button type="submit" class="text-[12px] lg:text-[14px] inline-flex justify-center py-2 px-4 border border-transparent shadow-sm rounded-sm text-white bg-mainGreen hover:bg-lime-200">
                                        Send Message
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script>
        const BASEURL= 'http://127.0.0.1:8000/api';
        const token = localStorage.getItem('accessToken');

        // Fetch report by tracking ID
        async function fetchReport(trackingId) {
            if (!trackingId) {
                trackingId = document.getElementById("tracking-id").value;
            }

            if (!trackingId) {
                alert("Please enter a tracking ID.");
                return;
            }

            try {
                const response = await fetch(`${BASEURL}/tracking_id/${trackingId}/`, {
                    headers: {
                        "Authorization": `Bearer ${token}`,
                    },
                });

                if (!response.ok) {
                    throw new Error("Report not found");
                }

                const data = await response.json();

                // Display report details
                document.getElementById("tracking-id-detail").textContent = data.tracking_id;
                document.getElementById("description").textContent = data.description;
                document.getElementById("agency").textContent = data.agency;
                document.getElementById("reporter-email").textContent = data.reporter_email;

                // Show report details and follow-up section
                document.getElementById("report-details").classList.remove("hidden");
                document.getElementById("follow-up-section").classList.remove("hidden");
            } catch (error) {
                console.error("Error fetching report:", error);
                alert("Report not found. Please check the tracking ID.");
            }
        }

        // Handle follow-up form submission
        document.getElementById("follow-up-form").addEventListener("submit", async function (event) {
            event.preventDefault();

            const trackingId = document.getElementById("tracking-id").value;
            const message = document.getElementById("message").value;

            if (!message) {
                alert("Follow-up message is required.");
                return;
            }

            try {
                const response = await fetch(`${BASEURL}/send_follow_up/${trackingId}/`, {
                    method: "POST",
                    headers: {
                        "Authorization": `Bearer ${token}`,
                        "Content-Type": "application/json",
                    },
                    body: JSON.stringify({ message }),
                });

                if (!response.ok) {
                    throw new Error("Failed to send follow-up message");
                }

                const data = await response.json();
                alert(data.message || "Follow-up message sent successfully!");
                document.getElementById("message").value = "";
            } catch (error) {
                console.error("Error sending follow-up message:", error);
                alert("Failed to send follow-up message. Please try again.");
            }
        });
    </script>
</body>
</html>