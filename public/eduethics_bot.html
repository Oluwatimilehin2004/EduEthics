<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EduEthics Bot</title>
    <link rel="stylesheet" href="./output.css">
</head>
<body class="font-[Inter] z-0">
    <header class="z-20 w-full p-3 border flex justify-between items-center bg-backgroundColor">
        <image id="menu-toggle" class="w-7 h-7 cursor-pointer" src="./assets/icons/menu.png"/>
        <a href="./index.html">
            <h1 class="font-bold text-[15px] lg:text-[17px]">EduEthics</h1>
        </a>
        <image id="new-chat-btn" class="w-7 h-7" src="./assets/icons/chat-bubble.png"/>
    </header>
    <section class="flex">
        <aside id="menu" class="z-10 fixed top-0 left-[-300px] w-64 h-full bg-backgroundColor transition-transform duration-300 transform overflow-y-scroll overflow-x-hidden">
            <header class="p-3.5 flex justify-between ">
                <!-- Menu header -->
                <img id="close-menu" class="w-7 h-7 cursor-pointer" src="./assets/icons/close.png"/>
                <h2 class="font-bold text-[15px] lg:text-[17px] text-black cursor-pointer p-1">EduEthics</h2>
                <image id="header-new-chat-btn" class="w-7 h-7 cursor-pointer" src="./assets/icons/chat-bubble.png"/>
            </header>
            <ul id="conversation-list" class="mt-4 px-3.5 flex-1 overflow-y-auto p-2">
                <!-- Conversations will be added here dynamically -->
            </ul>
        </aside> 
    </section>

    <main id="chat-container"  class="w-full lg:w-[65%] px-5 pt-5 flex m-auto transition-all duration-500">   
        <div class="flex flex-col min-h-[82vh] w-full overflow-hidden pb-12">
            <!-- Chat Messages Area -->
            <div id="chat-messages" class="flex-1 p-4 overflow-y-auto">
                <!-- Initial Welcome Message -->
                <div class="flex justify-center items-center h-full">
                    <div class="text-center max-w-md">
                        <h2 class="text-2xl font-bold mb-2">Welcome to your EduEthics Chat</h2>
                        <p class="text-gray-600">Start a new conversation or select one from your history</p>
                    </div>
                </div>
            </div>

            <!-- Chat Input Area -->
            <div class="rounded-lg relative">
                <div class="flex fixed w-[90%] lg:w-[65%] lg:m-auto bottom-3">
                    <input
                        id="chat-input"
                        type="text"
                        placeholder="Ask EduEthics Bot A Question..."
                        class="flex-1 border rounded-l-lg p-2 text-[12px] lg:text-[14px] focus:outline-none placeholder:text-[12px] placeholder:lg:text-[14px]"
                    />
                    <button
                        id="send-button"
                        class="bg-mainGreen text-white text-[12px] lg:text-[14px] px-4 py-2 rounded-r-lg hover:bg-bgBlue"
                    >
                        Send
                    </button>
                </div>
            </div>
        </div>
    </main>



    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // DOM Elements
            const menuToggle = document.getElementById('menu-toggle');
            const menu = document.getElementById('menu');
            const newChatBtn = document.getElementById('new-chat-btn');
            const headerNewChatBtn = document.getElementById('header-new-chat-btn');
            const conversationList = document.getElementById('conversation-list');
            const chatMessages = document.getElementById('chat-messages');
            const chatInput = document.getElementById('chat-input');
            const sendButton = document.getElementById('send-button');
            const closeMenuBar = document.getElementById('close-menu');
            
            // API Configuration
            const API_CONFIG = {
                baseUrl: 'http://127.0.0.1:8000//api/chat',
                endpoints: {
                    conversations: '/conversations/',
                    conversationDetail: '/conversations/', // Will append ID
                    sendMessage: '/messages/send/',
                    deleteConversation: '/conversations/' // Will append ID
                },
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${localStorage.getItem('token')}`
                }
            };

            // State
            let conversations = [];
            let currentConversationId = null;
            
            // Initialize
            fetchConversations();
            
            // Event Listeners
            headerNewChatBtn.addEventListener('click', createNewConversation);
            newChatBtn.addEventListener('click', createNewConversation);
            sendButton.addEventListener('click', sendMessage);
            closeMenuBar.addEventListener('click', closeMenu);
            chatInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') sendMessage();
            });

            // Toggle Menu
            menuToggle.addEventListener('click', function (e) {
                e.stopPropagation(); 
                menu.classList.toggle('translate-x-[300px]');
            });

            // Close menu when clicking outside
            document.addEventListener('click', function (e) {
                const isClickInsideMenu = menu.contains(e.target);
                const isClickOnMenuToggle = menuToggle.contains(e.target);

                if (!isClickInsideMenu && !isClickOnMenuToggle) {
                    menu.classList.remove('translate-x-[300px]');
                }
            });

            // Function Definitions  
            function closeMenu() {
                menu.classList.toggle('translate-x-[300px]');
            }

            async function fetchConversations() {
                try {
                    const response = await fetch(`${API_CONFIG.baseUrl}${API_CONFIG.endpoints.conversations}`, {
                        method: 'GET',
                        headers: API_CONFIG.headers
                    });
                    
                    const data = await response.json();
                    
                    if (response.ok) {
                        conversations = data;
                        renderConversationList();
                        
                        // Load the first conversation if available
                        if (conversations.length > 0) {
                            loadConversation(conversations[0].id);
                        }
                    }
                } catch (error) {
                    console.error('Error fetching conversations:', error);
                    // Fallback to localStorage if API fails
                    conversations = JSON.parse(localStorage.getItem('conversations')) || [];
                    renderConversationList();
                }
            }

            async function createNewConversation() {
                try {
                    const response = await fetch(`${API_CONFIG.baseUrl}${API_CONFIG.endpoints.conversations}`, {
                        method: 'POST',
                        headers: API_CONFIG.headers,
                        body: JSON.stringify({}) // Empty body creates new conversation
                    });
                    
                    const data = await response.json();
                    
                    if (response.ok) {
                        conversations.unshift(data);
                        currentConversationId = data.id;
                        saveConversations();
                        renderConversationList();
                        loadConversation(currentConversationId);
                    }
                } catch (error) {
                    console.error('Error creating new conversation:', error);
                    // Fallback to local storage
                    const newConversation = {
                        id: Date.now().toString(),
                        title: 'New Chat',
                        messages: [],
                        createdAt: new Date().toISOString()
                    };
                    
                    conversations.unshift(newConversation);
                    currentConversationId = newConversation.id;
                    saveConversations();
                    renderConversationList();
                    loadConversation(newConversation.id);
                }
            }

            function deleteChat() {
                if (!currentConversationId) return;
                
                if (confirm('Are you sure you want to delete this conversation?')) {
                    // API call to delete conversation
                    fetch(`${API_CONFIG.baseUrl}${API_CONFIG.endpoints.deleteConversation}${currentConversationId}/`, {
                        method: 'DELETE',
                        headers: API_CONFIG.headers
                    }).catch(error => console.error('Delete API error:', error));
                    
                    // Update local state
                    conversations = conversations.filter(c => c.id !== currentConversationId);
                    saveConversations();
                    renderConversationList();
                    chatMessages.innerHTML = `
                        <div class="flex justify-center items-center h-full">
                            <div class="text-center max-w-md">
                                <h2 class="text-2xl font-bold mb-2">Welcome to Deepseek Chat</h2>
                                <p class="text-gray-600">Start a new conversation or select one from your history</p>
                            </div>
                        </div>
                    `;
                    currentConversationId = null;
                }
            }

            function deleteConversation(conversationId, event) {
                event.stopPropagation();
                
                if (confirm('Are you sure you want to delete this conversation?')) {
                    // API call to delete conversation
                    fetch(`${API_CONFIG.baseUrl}${API_CONFIG.endpoints.deleteConversation}${conversationId}/`, {
                        method: 'DELETE',
                        headers: API_CONFIG.headers
                    }).catch(error => console.error('Delete API error:', error));
                    
                    // Update local state
                    conversations = conversations.filter(c => c.id !== conversationId);
                    saveConversations();
                    
                    if (currentConversationId === conversationId) {
                        currentConversationId = null;
                        chatMessages.innerHTML = `
                            <div class="flex justify-center items-center h-full">
                                <div class="text-center max-w-md">
                                    <h2 class="text-2xl font-bold mb-2">Welcome to Deepseek Chat</h2>
                                    <p class="text-gray-600">Start a new conversation or select one from your history</p>
                                </div>
                            </div>
                        `;
                    }
                    
                    renderConversationList();
                }
            }
            
            function renderConversationList() {
                conversationList.innerHTML = '';
                
                if (conversations.length === 0) {
                    conversationList.innerHTML = `
                        <div class="p-4 text-bgBlue text-center">
                            No chats yet
                        </div> 
                    `;
                    return;
                }
                
                conversations.forEach(conversation => {
                    const conversationElement = document.createElement('div');
                    conversationElement.className = `p-3 rounded-lg mb-1 cursor-pointer hover:bg-mainGreen ${currentConversationId === conversation.id ? 'bg-bgBlue' : ''}`;
                    conversationElement.innerHTML = `
                        <div class="font-medium truncate text-[14px] lg:text-[16px] capitalize">${conversation.title}</div>
                        <div class="text-[10px] lg:text-[12px] text-gray-400 flex justify-between">
                            ${formatDate(conversation.created_at || conversation.createdAt)}
                            <image class="delete-btn w-3 h-3" src="./assets/icons/delete.png" alt=" " />
                        </div>
                    `;
                    
                    conversationElement.addEventListener('click', () => {
                        loadConversation(conversation.id);
                        if (window.innerWidth < 768) {
                            menu.classList.remove('translate-x-[300px]');
                        }
                    });

                    const deleteBtn = conversationElement.querySelector('.delete-btn');
                    deleteBtn.addEventListener('click', (e) => {
                        deleteConversation(conversation.id, e);
                    });
                    
                    conversationList.appendChild(conversationElement);
                });
            }
            
            async function loadConversation(conversationId) {
                try {
                    const response = await fetch(`${API_CONFIG.baseUrl}${API_CONFIG.endpoints.conversationDetail}${conversationId}/`, {
                        method: 'GET',
                        headers: API_CONFIG.headers
                    });
                    
                    const data = await response.json();
                    
                    if (response.ok) {
                        currentConversationId = conversationId;
                        chatMessages.innerHTML = '';
                        
                        if (data.messages && data.messages.length > 0) {
                            data.messages.forEach(msg => {
                                addMessageToChat(msg.message, msg.is_user);
                            });
                        } else {
                            chatMessages.innerHTML = `
                                <div class="flex justify-center items-center h-full">
                                    <div class="text-center max-w-md">
                                        <h2 class="text-[14px] lg:text-[16px] font-bold mb-2">${data.title || 'New Chat'}</h2>
                                        <p class="text-gray-600 text-[12px] lg:text-[14px]">Start chatting</p>
                                    </div>
                                </div>
                            `;
                        }
                        
                        renderConversationList();
                        chatMessages.scrollTop = chatMessages.scrollHeight;
                    }
                } catch (error) {
                    console.error('Error loading conversation:', error);
                    // Fallback to local storage
                    const conversation = conversations.find(c => c.id === conversationId);
                    if (conversation) {
                        currentConversationId = conversationId;
                        chatMessages.innerHTML = '';
                        
                        if (conversation.messages.length > 0) {
                            conversation.messages.forEach(message => {
                                addMessageToChat(message.text, message.isUser);
                            });
                        } else {
                            chatMessages.innerHTML = `
                                <div class="flex justify-center items-center h-full">
                                    <div class="text-center max-w-md">
                                        <h2 class="text-[14px] lg:text-[16px] font-bold mb-2">${conversation.title}</h2>
                                        <p class="text-gray-600 text-[12px] lg:text-[14px]">Start chatting</p>
                                    </div>
                                </div>
                            `;
                        }
                        
                        renderConversationList();
                        chatMessages.scrollTop = chatMessages.scrollHeight;
                    }
                }
            }
            
            async function sendMessage() {
                const messageText = chatInput.value.trim();
                if (!messageText || !currentConversationId) return;
                
                // Optimistically add user message
                addMessageToChat(messageText, true);
                chatInput.value = '';
                
                try {
                    const response = await fetch(`${API_CONFIG.baseUrl}${API_CONFIG.endpoints.sendMessage}`, {
                        method: 'POST',
                        headers: API_CONFIG.headers,
                        body: JSON.stringify({
                            message: messageText,
                            conversation_id: currentConversationId
                        })
                    });
                    
                    const data = await response.json();
                    
                    if (response.ok) {
                        // Update conversation data from API response
                        const updatedConversation = data;
                        
                        // Find and update the conversation in our state
                        const conversationIndex = conversations.findIndex(c => c.id === updatedConversation.id);
                        if (conversationIndex !== -1) {
                            conversations[conversationIndex] = updatedConversation;
                        }
                        
                        // Clear and reload messages to ensure sync with backend
                        chatMessages.innerHTML = '';
                        if (updatedConversation.messages) {
                            updatedConversation.messages.forEach(msg => {
                                addMessageToChat(msg.message, msg.is_user);
                            });
                        }
                        
                        renderConversationList();
                    }
                } catch (error) {
                    console.error('Error sending message:', error);
                    // Show error message to user
                    addMessageToChat("Failed to send message. Please try again.", false);
                    
                    // Fallback to local storage
                    const conversation = conversations.find(c => c.id === currentConversationId);
                    if (conversation) {
                        conversation.messages.push({
                            text: messageText,
                            isUser: true,
                            timestamp: new Date().toISOString()
                        });
                        
                        if (conversation.messages.length === 1) {
                            conversation.title = messageText.slice(0, 30) + (messageText.length > 30 ? '...' : '');
                        }
                        
                        saveConversations();
                        renderConversationList();
                    }
                }
            }
            
            function addMessageToChat(text, isUser) {
                const messageElement = document.createElement('div');
                messageElement.className = `mb-4 ${isUser ? 'flex justify-end' : ''}`;
                
                messageElement.innerHTML = `
                    <div class="${isUser ? 'bg-bgBlue text-white' : 'bg-gray-200'} p-3 rounded-lg max-w-[80%]">
                        <p>${text}</p>
                    </div>
                `;
                
                chatMessages.appendChild(messageElement);
                chatMessages.scrollTop = chatMessages.scrollHeight;
            }
            
            function saveConversations() {
                localStorage.setItem('conversations', JSON.stringify(conversations));
            }
            
            function formatDate(isoString) {
                if (!isoString) return '';
                const date = new Date(isoString);
                return date.toLocaleDateString() + ' ' + date.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
            }
        });
    </script>
</body>
</html>